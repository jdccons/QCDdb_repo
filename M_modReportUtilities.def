Option Compare Database
Option Explicit

Dim db As DAO.Database
Dim rst As DAO.Recordset
Dim strSQL As String

Public g_dteMonthFirstDay As Date
Public g_dteMonthLastDay As Date

Function getCnt() As Long

    On Error GoTo ErrorHandler

    Set db = CurrentDb()
    
    strSQL = "SELECT Sum(tmpAA_AuditReport.Count) AS Cnt FROM tmpAA_AuditReport;"
    Set rst = db.OpenRecordset(strSQL, dbOpenSnapshot)
    If rst.RecordCount > 0 Then
        getCnt = rst.Fields("Cnt")
    Else
        getCnt = 0
    End If

    rst.Close
    Set db = Nothing
   
    
Exit_Point:
    Exit Function
    
ErrorHandler:
    MsgBox Err.DESCRIPTION & " " & Err.Number
    Resume Exit_Point

End Function

Function getPrem() As Double

    On Error GoTo ErrorHandler


    Set db = CurrentDb()
    
    strSQL = "SELECT Sum(tmpAA_AuditReport.Premium) AS Prem FROM tmpAA_AuditReport;"
    Set rst = db.OpenRecordset(strSQL, dbOpenSnapshot)
    If rst.RecordCount > 0 Then
        getPrem = rst.Fields("Prem")
    Else
        getPrem = 0
    End If
    
    rst.Close
    Set db = Nothing
   
Exit_Point:
    Exit Function
    
ErrorHandler:
    MsgBox Err.DESCRIPTION & " " & Err.Number
    Resume Exit_Point

End Function
Function PopulateAA_Audit(strGrpID As String) As Boolean

    On Error GoTo ErrorHandler

    Set db = CurrentDb()
    Dim rst2 As DAO.Recordset
    Dim strSQL2 As String
    Dim strPlanID As String
    Dim strCov As String
    
    strSQL = "SELECT tblGrp.GroupID, Count(tblSubscr.SUBssn) AS SubCnt, " & _
             "Sum(vwRates.Rate) AS SumRate, vwRates.Rate, tblSubscr.PlanID, " & _
             "vwRates.COVERcode, Right([PlanagerCode],3) AS Code, " & _
             "tlkpAllAmericanPlan.PlanagerCode " & _
             "FROM (tblGrp INNER JOIN (tblSubscr INNER JOIN " & _
             "tlkpAllAmericanPlan ON tblSubscr.PlanID = tlkpAllAmericanPlan.PlanID) " & _
             "ON tblGrp.GroupID = tblSubscr.SUBgroupID) INNER JOIN vwRates " & _
             "ON tblSubscr.RateID = vwRates.RateID " & _
             "GROUP BY tblGrp.GroupID, vwRates.Rate, tblSubscr.PlanID, " & _
             "vwRates.COVERcode, Right([PlanagerCode],3), " & _
             "tlkpAllAmericanPlan.PlanagerCode " & _
             "HAVING (((tblGrp.GroupID)='" & strGrpID & "') AND ((Right([PlanagerCode],3))='QCD')) " & _
             "OR (((tblGrp.GroupID)='" & strGrpID & "') AND ((tlkpAllAmericanPlan.PlanagerCode)='QCDBLU-MNL')) " & _
             "ORDER BY tblSubscr.PlanID, vwRates.COVERcode;"
             
    
  
  Set rst = db.OpenRecordset(strSQL, dbOpenSnapshot)
    If rst.RecordCount > 0 Then
    With rst2
     Do While Not rst.EOF
        strPlanID = rst.Fields("PlanID")
        strCov = rst.Fields("COVERcode")
        Select Case strPlanID
        Case "1"  ' Red Plan
          If strCov = "I" Then ' Individual
            strSQL2 = "Select * from tmpAA_AuditReport Where Sort = 1"
            Set rst2 = db.OpenRecordset(strSQL2, dbOpenDynaset, dbSeeChanges)
            rst2.Edit
            rst2.Fields("Count") = rst.Fields("SubCnt")
            rst2.Fields("Rate") = rst.Fields("Rate")
            rst2.Fields("Premium") = rst.Fields("SumRate")
          ElseIf strCov = "O" Then ' Other
            strSQL2 = "Select * from tmpAA_AuditReport Where Sort = 2"
            Set rst2 = db.OpenRecordset(strSQL2, dbOpenDynaset, dbSeeChanges)
            rst2.Edit
            rst2.Fields("Count") = rst.Fields("SubCnt")
            rst2.Fields("Rate") = rst.Fields("Rate")
            rst2.Fields("Premium") = rst.Fields("SumRate")
          ElseIf strCov = "F" Then ' Family
            strSQL2 = "Select * from tmpAA_AuditReport Where Sort = 3"
            Set rst2 = db.OpenRecordset(strSQL2, dbOpenDynaset, dbSeeChanges)
            rst2.Edit
            rst2.Fields("Count") = rst.Fields("SubCnt")
            rst2.Fields("Rate") = rst.Fields("Rate")
            rst2.Fields("Premium") = rst.Fields("SumRate")
          End If
          rst2.Update
          rst2.Close
        Case "2"  'White Plan
          If strCov = "I" Then
            strSQL2 = "Select * from tmpAA_AuditReport Where Sort = 5"
            Set rst2 = db.OpenRecordset(strSQL2, dbOpenDynaset, dbSeeChanges)
            rst2.Edit
            rst2.Fields("Count") = rst.Fields("SubCnt")
            rst2.Fields("Rate") = rst.Fields("Rate")
            rst2.Fields("Premium") = rst.Fields("SumRate")
          ElseIf strCov = "O" Then
            strSQL2 = "Select * from tmpAA_AuditReport Where Sort = 6"
            Set rst2 = db.OpenRecordset(strSQL2, dbOpenDynaset, dbSeeChanges)
            rst2.Edit
            rst2.Fields("Count") = rst.Fields("SubCnt")
            rst2.Fields("Rate") = rst.Fields("Rate")
            rst2.Fields("Premium") = rst.Fields("SumRate")
          ElseIf strCov = "F" Then
            strSQL2 = "Select * from tmpAA_AuditReport Where Sort = 7"
            Set rst2 = db.OpenRecordset(strSQL2, dbOpenDynaset, dbSeeChanges)
            rst2.Edit
            rst2.Fields("Count") = rst.Fields("SubCnt")
            rst2.Fields("Rate") = rst.Fields("Rate")
            rst2.Fields("Premium") = rst.Fields("SumRate")
          End If
          rst2.Update
          rst2.Close
        Case "3"  'Blue Plan
                  'Blue is insurance only - there is never a
                  'rate for the QCD portion of the Blue plan
                  'QCD gets paid a commisson on the premiums
                  'charge to subscribers for the Blue plan
          If strCov = "I" Then
            strSQL2 = "Select * from tmpAA_AuditReport Where Sort = 9"
            Set rst2 = db.OpenRecordset(strSQL2, dbOpenDynaset, dbSeeChanges)
            rst2.Edit
            rst2.Fields("Count") = rst.Fields("SubCnt")
            'rst2.Fields("Rate") = rst.Fields("Rate")
            'rst2.Fields("Premium") = rst.Fields("SumRate")
          ElseIf strCov = "O" Then
            strSQL2 = "Select * from tmpAA_AuditReport Where Sort = 10"
            Set rst2 = db.OpenRecordset(strSQL2, dbOpenDynaset, dbSeeChanges)
            rst2.Edit
            rst2.Fields("Count") = rst.Fields("SubCnt")
            'rst2.Fields("Rate") = rst.Fields("Rate")
            'rst2.Fields("Premium") = rst.Fields("SumRate")
            rst2.Fields("Rate") = 0
            rst2.Fields("Premium") = 0
          ElseIf strCov = "F" Then
            strSQL2 = "Select * from tmpAA_AuditReport Where Sort = 11"
            Set rst2 = db.OpenRecordset(strSQL2, dbOpenDynaset, dbSeeChanges)
            rst2.Edit
            rst2.Fields("Count") = rst.Fields("SubCnt")
            'rst2.Fields("Rate") = rst.Fields("Rate")
            'rst2.Fields("Premium") = rst.Fields("SumRate")
            rst2.Fields("Rate") = 0
            rst2.Fields("Premium") = 0
          End If
          rst2.Update
          rst2.Close
        Case "4" 'Red Plus Plan
          If strCov = "I" Then
            strSQL2 = "Select * from tmpAA_AuditReport Where Sort = 13"
            Set rst2 = db.OpenRecordset(strSQL2, dbOpenDynaset, dbSeeChanges)
            rst2.Edit
            rst2.Fields("Count") = rst.Fields("SubCnt")
            rst2.Fields("Rate") = rst.Fields("Rate")
            rst2.Fields("Premium") = rst.Fields("SumRate")
          ElseIf strCov = "O" Then
            strSQL2 = "Select * from tmpAA_AuditReport Where Sort = 14"
            Set rst2 = db.OpenRecordset(strSQL2, dbOpenDynaset, dbSeeChanges)
            rst2.Edit
            rst2.Fields("Count") = rst.Fields("SubCnt")
            rst2.Fields("Rate") = rst.Fields("Rate")
            rst2.Fields("Premium") = rst.Fields("SumRate")
          ElseIf strCov = "F" Then
            strSQL2 = "Select * from tmpAA_AuditReport Where Sort = 15"
            Set rst2 = db.OpenRecordset(strSQL2, dbOpenDynaset, dbSeeChanges)
            rst2.Edit
            rst2.Fields("Count") = rst.Fields("SubCnt")
            rst2.Fields("Rate") = rst.Fields("Rate")
            rst2.Fields("Premium") = rst.Fields("SumRate")
          End If
          rst2.Update
          rst2.Close
        End Select
        rst.MoveNext
     Loop
    End With
    End If
    
    PopulateAA_Audit = True
        
    Set db = Nothing
   
Exit_Point:
    Exit Function
    
ErrorHandler:
    MsgBox Err.DESCRIPTION & " " & Err.Number
    Resume Exit_Point

End Function
Function GetAA_Cnt(strGrpID As String, strPlanID As Long, strCov As String, strCnt As String) As Long

    On Error GoTo ErrorHandler

    Set db = CurrentDb()
    Dim rst2 As DAO.Recordset
    Dim strSQL2 As String
        
    strSQL = "SELECT tblGrp.GroupID, Count(tblSubscr.SUBssn) AS SubCnt, tblSubscr.PlanID, tblCoverage.COVERcode " & _
             "FROM (tblGrp INNER JOIN tblSubscr ON tblGrp.GroupID = tblSubscr.SUBgroupID) INNER JOIN tblCoverage ON tblSubscr.CoverID = tblCoverage.CoverID " & _
             "GROUP BY tblGrp.GroupID, tblSubscr.PlanID, tblCoverage.COVERcode " & _
             "HAVING (((tblGrp.GroupID)='" & strGrpID & "') AND ((tblSubscr.PlanID)=" & strPlanID & ") AND ((tblCoverage.COVERcode)='" & strCov & "'));"

    Set rst = db.OpenRecordset(strSQL, dbOpenSnapshot)
    If rst.RecordCount > 0 Then
     With rst
      Select Case strCnt
      Case "S"
        GetAA_Cnt = rst.Fields("SubCnt")
      Case "D"
        GetAA_Cnt = 0  'rst.Fields("DepCnt")
      End Select
     End With
    Else
        GetAA_Cnt = 0
    End If
    
    Set db = Nothing
    
Exit_Point:
    Exit Function
    
ErrorHandler:
    MsgBox Err.DESCRIPTION & " " & Err.Number
    Resume Exit_Point
    
End Function